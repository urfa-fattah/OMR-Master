<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMR Master Pro - Active Session</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        bangla: ['Hind Siliguri', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out forwards',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-attachment: fixed;
            background: radial-gradient(circle at top left, #f8fafc, #e2e8f0); 
        }
        .dark body {
            background: radial-gradient(circle at top left, #0f172a, #1e293b);
        }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }
        .dark .nav-glass {
            background: rgba(15, 23, 42, 0.85);
            border-bottom: 1px solid rgba(30, 41, 59, 0.8);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Bubble Animation */
        .bubble {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .bubble:active {
            transform: scale(0.95);
        }

        /* Exam Container Responsive */
        @media (max-width: 1024px) {
            .exam-grid {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        @media (max-width: 640px) {
            .exam-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* Timer Animation */
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .timer-warning {
            animation: pulse-warning 1s infinite;
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-100 transition-colors duration-300 antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, createContext, useContext } = React;

        // --- Translations ---
        const translations = {
            en: {
                app_name: "OMR Master", pro: "PRO", dashboard: "Dashboard", active_session: "Active Session",
                analytics: "Analytics", about: "About", report: "Report Issues", guideline: "Guidelines", contact: "Contact",
                footer_credit: "Designed & Developed by", footer_rights: "All Rights Reserved.",
                // Exam Specific
                exam_title: "Active Exam Session",
                time_left: "Time Left",
                attempted: "Attempted",
                submit_exam: "Submit Exam",
                confirm_submit: "Are you sure you want to submit? This cannot be undone.",
                focus_mode: "Focus Mode",
                pdf_viewer: "Question Paper",
                open_new_tab: "Open in New Tab",
                flag_review: "Click number to flag for review",
                clear_selection: "Clear Selection",
                exam_completed: "Exam Completed!",
                saving_progress: "Saving progress...",
                low_time_warning: "Less than 1 minute remaining!",
                loading_exam: "Loading Exam Environment...",
                resume_exam: "Resume Exam",
                // Tooltips
                tooltip_submit: "Submit your exam for grading",
                tooltip_focus: "Enter distraction-free mode",
                tooltip_flag: "Mark question for review",
                tooltip_clear: "Remove your answer selection",
                // Stats
                unanswered: "Unanswered",
                flagged: "Flagged",
                progress: "Progress",
                // Navigation
                previous: "Previous",
                next: "Next",
                question: "Question",
                of: "of",
                // Retake
                retake_mode: "Retake Mode",
                previous_score: "Previous Score",
                // Status
                saved: "Saved",
                saving: "Saving..."
            },
            bn: {
                app_name: "‡¶ì‡¶è‡¶Æ‡¶Ü‡¶∞ ‡¶Æ‡¶æ‡¶∏‡ßç‡¶ü‡¶æ‡¶∞", pro: "‡¶™‡ßç‡¶∞‡ßã", dashboard: "‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°", active_session: "‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶∏‡ßá‡¶∂‡¶®",
                analytics: "‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£", about: "‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá", report: "‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶ú‡¶æ‡¶®‡¶æ‡¶®", guideline: "‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡ßá‡¶∂‡¶æ‡¶¨‡¶≤‡ßÄ", contact: "‡¶Ø‡ßã‡¶ó‡¶æ‡¶Ø‡ßã‡¶ó",
                footer_credit: "‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® ‡¶ì ‡¶°‡ßá‡¶≠‡ßá‡¶≤‡¶™‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá", footer_rights: "‡¶∏‡¶∞‡ßç‡¶¨‡¶∏‡ßç‡¶¨‡¶§‡ßç‡¶¨ ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§‡•§",
                // Exam Specific
                exam_title: "‡¶ö‡¶≤‡¶Æ‡¶æ‡¶® ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡ßá‡¶∂‡¶®",
                time_left: "‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶æ‡¶ï‡¶ø",
                attempted: "‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡ßá‡¶ì‡¶Ø‡¶º‡¶æ",
                submit_exam: "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®",
                confirm_submit: "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶ü‡¶ø ‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶æ‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶Ø‡¶º ‡¶´‡ßá‡¶∞‡¶æ‡¶®‡ßã ‡¶Ø‡¶æ‡¶¨‡ßá ‡¶®‡¶æ‡•§",
                focus_mode: "‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶Æ‡ßã‡¶°",
                pdf_viewer: "‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡¶™‡¶§‡ßç‡¶∞",
                open_new_tab: "‡¶®‡¶§‡ßÅ‡¶® ‡¶ü‡ßç‡¶Ø‡¶æ‡¶¨‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®",
                flag_review: "‡¶∞‡¶ø‡¶≠‡¶ø‡¶â‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶§‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®",
                clear_selection: "‡¶∏‡¶ø‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶Æ‡ßÅ‡¶õ‡ßÅ‡¶®",
                exam_completed: "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®!",
                saving_progress: "‡¶™‡ßç‡¶∞‡¶ó‡¶§‡¶ø ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...",
                low_time_warning: "‡ßß ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá‡¶∞ ‡¶ï‡¶Æ ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶¨‡¶æ‡¶ï‡¶ø!",
                loading_exam: "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡ßá‡¶∂ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...",
                resume_exam: "‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®",
                // Tooltips
                tooltip_submit: "‡¶ó‡ßç‡¶∞‡ßá‡¶°‡¶ø‡¶Ç‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶®",
                tooltip_focus: "‡¶¨‡¶ø‡¶ï‡ßç‡¶∑‡ßá‡¶™-‡¶Æ‡ßÅ‡¶ï‡ßç‡¶§ ‡¶Æ‡ßã‡¶°‡ßá ‡¶™‡ßç‡¶∞‡¶¨‡ßá‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®",
                tooltip_flag: "‡¶∞‡¶ø‡¶≠‡¶ø‡¶â‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶®",
                tooltip_clear: "‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶∏‡¶∞‡¶æ‡¶®",
                // Stats
                unanswered: "‡¶â‡¶§‡ßç‡¶§‡¶∞‡¶π‡ßÄ‡¶®",
                flagged: "‡¶ö‡¶ø‡¶π‡ßç‡¶®‡¶ø‡¶§",
                progress: "‡¶™‡ßç‡¶∞‡¶ó‡¶§‡¶ø",
                // Navigation
                previous: "‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ",
                next: "‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ",
                question: "‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®",
                of: "‡¶è‡¶∞",
                // Retake
                retake_mode: "‡¶™‡ßÅ‡¶®‡¶∞‡¶æ‡¶Ø‡¶º ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶Æ‡ßã‡¶°",
                previous_score: "‡¶™‡ßÇ‡¶∞‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶∏‡ßç‡¶ï‡ßã‡¶∞",
                // Status
                saved: "‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§",
                saving: "‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶π‡¶ö‡ßç‡¶õ‡ßá..."
            }
        };

        // --- Icons ---
        const Icons = {
            Home: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Play: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            BarChart: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="20" x2="12" y2="10"/><line x1="18" y1="20" x2="18" y2="4"/><line x1="6" y1="20" x2="6" y2="16"/></svg>,
            Sun: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>,
            Moon: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>,
            Globe: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>,
            Focus: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            ExternalLink: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>,
            Book: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Flag: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></svg>,
            Mail: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>,
            Clock: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            CheckCircle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            AlertCircle: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            X: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            ChevronLeft: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            Save: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            Refresh: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
        };

        const AppContext = createContext();

        // --- Navbar (Matching index.html) ---
        const Navbar = ({ activePage, toggleFocus, isFocusMode, timeLeft, examName }) => {
            const { lang, setLang, darkMode, setDarkMode } = useContext(AppContext);
            const [sessionActive, setSessionActive] = useState(false);
            const [isOpen, setIsOpen] = useState(false);
            const t = (k) => translations[lang][k];

            useEffect(() => {
                const session = localStorage.getItem('omr_current_session');
                if (session) setSessionActive(true);
            }, []);

            const toggleTheme = () => {
                setDarkMode(!darkMode);
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', !darkMode ? 'dark' : 'light');
            };

            const toggleLang = () => {
                const newLang = lang === 'en' ? 'bn' : 'en';
                setLang(newLang);
                localStorage.setItem('lang', newLang);
            };

            const formatTime = (seconds) => {
                const m = Math.floor(seconds / 60);
                const s = seconds % 60;
                return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            };

            const isLowTime = timeLeft < 60;

            const links = [
                { name: t('dashboard'), href: 'index.html', icon: Icons.Home, active: activePage === 'home' },
                { name: t('active_session'), href: 'exam.html', icon: Icons.Play, active: activePage === 'exam', hidden: !sessionActive },
                { name: t('analytics'), href: 'analytics.html', icon: Icons.BarChart, active: activePage === 'analytics' },
            ];

            const secondaryLinks = [
                { name: t('about'), icon: Icons.Book, href: 'about.html' },
                { name: t('guideline'), icon: Icons.Flag, href: 'guidelines.html' },
                { name: t('report'), icon: Icons.AlertCircle, href: 'report.html' },
                { name: t('contact'), icon: Icons.Mail, href: 'contact.html' },
            ];

            if (isFocusMode) return null;

            return (
                <nav className="fixed top-0 inset-x-0 z-50 nav-glass transition-all duration-300 shadow-sm">
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between items-center h-20">
                            {/* Logo */}
                            <div className="flex items-center gap-3 cursor-pointer group" onClick={() => window.location.href='index.html'}>
                                <div className="w-10 h-10 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/20 transition-transform group-hover:scale-105 group-hover:rotate-3">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/></svg>
                                </div>
                                <div className={lang === 'bn' ? 'font-bangla' : ''}>
                                    <h1 className="text-xl font-bold text-slate-800 dark:text-white tracking-tight leading-none">{t('app_name')}</h1>
                                    <span className="text-[10px] font-bold tracking-widest text-blue-600 dark:text-blue-400 uppercase">{t('pro')}</span>
                                    {examName && (
                                        <p className="text-xs text-slate-500 dark:text-slate-400 truncate max-w-xs">
                                            {examName}
                                        </p>
                                    )}
                                </div>
                            </div>

                            {/* Desktop Navigation */}
                            <div className="hidden lg:flex items-center gap-2">
                                <div className="flex items-center gap-1 mr-4 bg-slate-100 dark:bg-slate-800 p-1.5 rounded-full border border-slate-200 dark:border-slate-700">
                                    {links.map(link => !link.hidden && (
                                        <a key={link.name} href={link.href} className={`flex items-center gap-2 px-4 py-2 rounded-full text-sm font-bold transition-all duration-200 ${link.active ? 'bg-white dark:bg-slate-600 text-blue-600 dark:text-blue-300 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-slate-200'}`}>
                                            <link.icon /> <span className={lang === 'bn' ? 'font-bangla' : ''}>{link.name}</span>
                                        </a>
                                    ))}
                                </div>
                                
                                {secondaryLinks.map((item, idx) => (
                                    <a key={idx} href={item.href} title={item.name} className="p-2.5 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                        <item.icon />
                                    </a>
                                ))}
                                
                                <div className="h-6 w-px bg-slate-200 dark:bg-slate-700 mx-2"></div>
                                
                                {/* Timer Display */}
                                <div className={`flex items-center gap-2 px-4 py-2 rounded-xl font-mono font-bold ${isLowTime ? 'bg-red-500/10 text-red-600 timer-warning border border-red-500/20' : 'bg-blue-500/10 text-blue-600 border border-blue-500/20'}`}>
                                    <Icons.Clock />
                                    {formatTime(timeLeft)}
                                </div>
                                
                                <button onClick={toggleFocus} className="flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 font-bold text-sm hover:scale-105 transition-transform">
                                    <Icons.Focus /> {t('focus_mode')}
                                </button>
                                
                                <button onClick={toggleLang} className="flex items-center gap-2 px-3 py-2 rounded-xl bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 font-bold text-sm hover:scale-105 transition-transform">
                                    <Icons.Globe /> {lang === 'en' ? 'BN' : 'EN'}
                                </button>
                                
                                <button onClick={toggleTheme} className="p-2.5 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:rotate-12 transition-transform">
                                    {darkMode ? <Icons.Sun /> : <Icons.Moon />}
                                </button>
                            </div>

                            {/* Mobile Navigation */}
                            <div className="lg:hidden flex items-center gap-3">
                                <div className={`font-mono text-lg font-bold px-3 py-1.5 rounded ${isLowTime ? 'bg-red-500/10 text-red-600 timer-warning' : 'bg-blue-500/10 text-blue-600'}`}>
                                    {formatTime(timeLeft)}
                                </div>
                                <button onClick={toggleLang} className="text-sm font-bold text-indigo-600 dark:text-indigo-400">{lang === 'en' ? 'BN' : 'EN'}</button>
                                <button onClick={toggleTheme} className="text-slate-600 dark:text-slate-300">{darkMode ? <Icons.Sun /> : <Icons.Moon />}</button>
                                <button onClick={() => setIsOpen(!isOpen)} className="p-2 text-slate-500 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition">
                                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d={isOpen ? "M6 18L18 6M6 6l12 12" : "M4 6h16M4 12h16M4 18h16"} /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    {/* Mobile Menu */}
                    {isOpen && (
                        <div className="lg:hidden border-t border-slate-100 dark:border-slate-800 bg-white/95 dark:bg-slate-900/95 backdrop-blur-xl absolute w-full shadow-xl">
                            <div className="p-4 space-y-2">
                                {links.map(link => !link.hidden && (
                                    <a key={link.name} href={link.href} className={`flex items-center gap-3 px-4 py-3 rounded-xl text-base font-medium ${link.active ? 'bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300' : 'text-slate-600 dark:text-slate-400'}`}>
                                        <link.icon /> <span className={lang === 'bn' ? 'font-bangla' : ''}>{link.name}</span>
                                    </a>
                                ))}
                                <hr className="border-slate-100 dark:border-slate-800 my-2" />
                                {secondaryLinks.map((item, idx) => (
                                    <a key={idx} href={item.href} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-base font-medium text-slate-600 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-800">
                                        <item.icon /> <span className={lang === 'bn' ? 'font-bangla' : ''}>{item.name}</span>
                                    </a>
                                ))}
                                <button onClick={toggleFocus} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-base font-medium text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/20">
                                    <Icons.Focus /> {t('focus_mode')}
                                </button>
                            </div>
                        </div>
                    )}
                </nav>
            );
        };

        // --- Footer (Matching index.html) ---
        const Footer = () => {
            const { lang } = useContext(AppContext);
            const t = (k) => translations[lang][k];
            return (
                <footer className="border-t border-slate-200 dark:border-slate-800 bg-white/50 dark:bg-slate-900/50 backdrop-blur-lg">
                    <div className="max-w-7xl mx-auto px-4 py-6 flex flex-col items-center justify-center gap-2 text-center">
                        <div className="flex items-center gap-2 text-slate-800 dark:text-slate-200 font-bold text-lg">
                            <span className="w-8 h-8 bg-blue-600 text-white flex items-center justify-center rounded-lg">UH</span>
                            Urfa Hasan Fattah
                        </div>
                        <p className={`text-sm text-slate-500 dark:text-slate-400 ${lang === 'bn' ? 'font-bangla' : ''}`}>
                            {t('footer_credit')} <span className="font-semibold text-slate-700 dark:text-slate-300">Urfa Hasan Fattah</span>. &copy; {new Date().getFullYear()} {t('footer_rights')}
                        </p>
                    </div>
                </footer>
            );
        };

        // --- Main Exam Component ---
        const ExamInterface = () => {
            const { lang, darkMode } = useContext(AppContext);
            const t = (k) => translations[lang][k];
            const [session, setSession] = useState(null);
            const [timeLeft, setTimeLeft] = useState(0);
            const [isFocusMode, setIsFocusMode] = useState(false);
            const [answers, setAnswers] = useState({});
            const [flags, setFlags] = useState([]);
            const [autoSaveStatus, setAutoSaveStatus] = useState("saved");
            const [currentQuestion, setCurrentQuestion] = useState(1);
            
            const answersRef = useRef({});
            const timerRef = useRef(null);
            const saveIntervalRef = useRef(null);

            // 1. Initialize
            useEffect(() => {
                const stored = localStorage.getItem('omr_current_session');
                const retakeConfig = localStorage.getItem('omr_retake_exam_config');
                
                if (retakeConfig) {
                    // Handle retake exam
                    const parsedRetake = JSON.parse(retakeConfig);
                    const newSession = {
                        config: parsedRetake.config,
                        timeLeft: parsedRetake.config.duration * 60,
                        answers: {},
                        flags: [],
                        startedAt: new Date().toISOString(),
                        examName: parsedRetake.examName,
                        isRetake: true,
                        previousScore: parsedRetake.previousScore || null
                    };
                    
                    setSession(newSession);
                    setTimeLeft(newSession.config.duration * 60);
                    
                    // Store session
                    localStorage.setItem('omr_current_session', JSON.stringify(newSession));
                    localStorage.removeItem('omr_retake_exam_config');
                } else if (stored) {
                    // Normal session
                    const parsed = JSON.parse(stored);
                    setSession(parsed);
                    setTimeLeft(parsed.timeLeft);
                    setAnswers(parsed.answers || {});
                    setFlags(parsed.flags || []);
                    answersRef.current = parsed.answers || {};
                } else {
                    window.location.href = 'index.html';
                }
            }, []);

            // 2. Submit Logic
            const submitExam = useCallback((isTimeout = false) => {
                if (!session) return;
                
                const finalAnswers = answersRef.current;
                
                const gradingData = {
                    config: session.config,
                    answers: finalAnswers,
                    timeTaken: session.config.duration * 60 - (isTimeout ? 0 : timeLeft),
                    submitTime: new Date().toISOString(),
                    flags: flags,
                    examName: session.examName || 'Untitled Exam',
                    isRetake: session.isRetake || false,
                    previousScore: session.previousScore || null
                };

                // Store for correction page
                localStorage.setItem('omr_temp_grading', JSON.stringify(gradingData));
                
                // Add to exam history
                const history = JSON.parse(localStorage.getItem('omr_exam_history') || '[]');
                history.push(gradingData);
                localStorage.setItem('omr_exam_history', JSON.stringify(history));
                
                // Clear current session
                localStorage.removeItem('omr_current_session');
                
                window.location.href = 'correction.html';
            }, [session, timeLeft, flags]);

            // 3. Timer Logic
            useEffect(() => {
                if (!session) return;

                timerRef.current = setInterval(() => {
                    setTimeLeft((prev) => {
                        if (prev <= 1) {
                            clearInterval(timerRef.current);
                            submitExam(true);
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(timerRef.current);
            }, [session, submitExam]);

            // 4. Auto-Save Logic
            useEffect(() => {
                if (!session) return;
                
                // Auto-save every 10 seconds
                saveIntervalRef.current = setInterval(() => {
                    autoSaveProgress();
                }, 10000);

                return () => clearInterval(saveIntervalRef.current);
            }, [session, flags, timeLeft, answers]);

            // Handlers
            const handleBubbleClick = (qNum, option) => {
                setAnswers(prev => {
                    const next = { ...prev, [qNum]: option };
                    answersRef.current = next;
                    return next;
                });
            };

            const clearRow = (qNum) => {
                setAnswers(prev => {
                    const next = { ...prev };
                    delete next[qNum];
                    answersRef.current = next;
                    return next;
                });
            };

            const toggleFlag = (qNum) => {
                setFlags(prev => prev.includes(qNum) ? prev.filter(f => f !== qNum) : [...prev, qNum]);
            };

            const navigateQuestion = (direction) => {
                const newQuestion = currentQuestion + direction;
                if (newQuestion >= 1 && newQuestion <= session?.config.questionCount) {
                    setCurrentQuestion(newQuestion);
                    
                    // Scroll to question on mobile
                    if (window.innerWidth < 1024) {
                        const element = document.getElementById(`question-${newQuestion}`);
                        if (element) {
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                }
            };

            const autoSaveProgress = (manual = false) => {
                if (!session) return;
                
                const currentData = JSON.parse(localStorage.getItem('omr_current_session') || '{}');
                const updated = {
                    ...currentData,
                    answers: answersRef.current,
                    timeLeft: timeLeft,
                    flags: flags,
                    lastSaved: new Date().toISOString()
                };
                
                localStorage.setItem('omr_current_session', JSON.stringify(updated));
                
                if (manual) {
                    setAutoSaveStatus("saved");
                } else {
                    setAutoSaveStatus("saving");
                    setTimeout(() => setAutoSaveStatus("saved"), 500);
                }
            };

            const toggleFocusMode = () => {
                setIsFocusMode(!isFocusMode);
            };

            if (!session) return (
                <div className="flex h-screen items-center justify-center">
                    <div className="text-center">
                        <div className="w-16 h-16 mx-auto mb-6 rounded-full bg-gradient-to-r from-blue-600 to-indigo-600 flex items-center justify-center">
                            <Icons.Play className="text-white text-2xl" />
                        </div>
                        <h2 className="text-2xl font-bold text-slate-800 dark:text-white mb-2">{t('loading_exam')}</h2>
                        <p className="text-slate-500 dark:text-slate-400">{session?.examName || 'Loading...'}</p>
                    </div>
                </div>
            );

            const { config } = session;
            const options = ['A', 'B', 'C', 'D', 'E'].slice(0, config.optionsCount);
            
            const isLowTime = timeLeft < 60;
            const attemptedCount = Object.keys(answers).length;
            const progressPercentage = (attemptedCount / config.questionCount) * 100;
            const unansweredCount = config.questionCount - attemptedCount;

            return (
                <div className="min-h-screen flex flex-col">
                    <Navbar 
                        activePage="exam"
                        toggleFocus={toggleFocusMode} 
                        isFocusMode={isFocusMode} 
                        timeLeft={timeLeft}
                        examName={session.examName}
                    />

                    <main className="flex-grow pt-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            {/* Stats Bar */}
                            <div className="glass-panel rounded-2xl p-4 mb-6 shadow-lg">
                                <div className="flex flex-wrap items-center justify-between gap-4">
                                    {/* Left Stats */}
                                    <div className="flex flex-wrap items-center gap-6">
                                        <div className="flex items-center gap-3">
                                            <div className="w-10 h-10 bg-gradient-to-br from-blue-100 to-blue-200 dark:from-blue-900/30 dark:to-blue-800/30 text-blue-600 dark:text-blue-400 rounded-xl flex items-center justify-center">
                                                <Icons.CheckCircle />
                                            </div>
                                            <div>
                                                <div className="text-sm text-slate-500 dark:text-slate-400">{t('attempted')}</div>
                                                <div className="font-bold text-slate-800 dark:text-white text-xl">
                                                    {attemptedCount} / {config.questionCount}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div className="hidden md:block">
                                            <div className="flex items-center gap-3">
                                                <div className="w-48 h-2 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
                                                    <div className="h-full bg-gradient-to-r from-blue-500 to-indigo-500 rounded-full transition-all duration-300" 
                                                         style={{width: `${progressPercentage}%`}}></div>
                                                </div>
                                                <span className="text-sm font-bold text-blue-600 dark:text-blue-400">{progressPercentage.toFixed(0)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Right Actions */}
                                    <div className="flex flex-wrap items-center gap-3">
                                        {isLowTime && (
                                            <div className="flex items-center gap-2 text-red-600 dark:text-red-400">
                                                <Icons.AlertCircle />
                                                <span className="text-sm font-bold">{t('low_time_warning')}</span>
                                            </div>
                                        )}
                                        
                                        <div className="flex items-center gap-2 text-sm text-slate-500 dark:text-slate-400">
                                            <div className={`w-2 h-2 rounded-full ${autoSaveStatus === 'saved' ? 'bg-green-500' : 'bg-amber-500 animate-pulse'}`}></div>
                                            {autoSaveStatus === 'saving' ? t('saving') : t('saved')}
                                        </div>
                                        
                                        <button 
                                            onClick={() => autoSaveProgress(true)}
                                            className="flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-700 transition"
                                        >
                                            <Icons.Save /> Save
                                        </button>
                                        
                                        <button 
                                            onClick={() => {
                                                if(confirm(t('confirm_submit'))) {
                                                    submitExam();
                                                }
                                            }}
                                            className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white px-5 py-2.5 rounded-xl shadow-lg shadow-green-500/20 font-bold transition-all hover:scale-105"
                                        >
                                            {t('submit_exam')}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Main Content */}
                            <div className="flex flex-col lg:flex-row gap-6">
                                {/* PDF Viewer - Desktop */}
                                {config.pdfLink && !isFocusMode && (
                                    <div className="hidden lg:block lg:w-1/2">
                                        <div className="glass-panel rounded-2xl overflow-hidden shadow-lg h-[calc(100vh-180px)] flex flex-col">
                                            <div className="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-3 flex justify-between items-center">
                                                <div className="flex items-center gap-2">
                                                    <Icons.Book />
                                                    <span className="text-sm font-medium">{t('pdf_viewer')}</span>
                                                </div>
                                                <a href={config.pdfLink} target="_blank" rel="noopener noreferrer" 
                                                   className="text-xs bg-white/20 hover:bg-white/30 px-2 py-1 rounded flex items-center gap-1 transition">
                                                    <Icons.ExternalLink /> {t('open_new_tab')}
                                                </a>
                                            </div>
                                            <iframe 
                                                src={config.pdfLink} 
                                                className="flex-grow w-full"
                                                title="Question Paper"
                                            ></iframe>
                                        </div>
                                    </div>
                                )}

                                {/* OMR Sheet */}
                                <div className={`glass-panel rounded-2xl shadow-lg ${config.pdfLink && !isFocusMode ? 'lg:w-1/2' : 'w-full'}`}>
                                    {/* Navigation Bar */}
                                    <div className="p-4 border-b border-slate-200 dark:border-slate-700">
                                        <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                                            <div className="flex items-center gap-4">
                                                <button 
                                                    onClick={() => navigateQuestion(-1)}
                                                    disabled={currentQuestion === 1}
                                                    className={`flex items-center gap-2 px-4 py-2 rounded-xl ${currentQuestion === 1 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}
                                                >
                                                    <Icons.ChevronLeft /> {t('previous')}
                                                </button>
                                                
                                                <div className="text-center">
                                                    <div className="text-sm text-slate-500 dark:text-slate-400">{t('question')}</div>
                                                    <div className="font-bold text-xl text-slate-800 dark:text-white">
                                                        {currentQuestion} {t('of')} {config.questionCount}
                                                    </div>
                                                </div>
                                                
                                                <button 
                                                    onClick={() => navigateQuestion(1)}
                                                    disabled={currentQuestion === config.questionCount}
                                                    className={`flex items-center gap-2 px-4 py-2 rounded-xl ${currentQuestion === config.questionCount ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-100 dark:hover:bg-slate-700'}`}
                                                >
                                                    {t('next')} <Icons.ChevronRight />
                                                </button>
                                            </div>
                                            
                                            <div className="flex items-center gap-2">
                                                <button 
                                                    onClick={() => toggleFlag(currentQuestion)}
                                                    className={`px-3 py-2 rounded-lg ${flags.includes(currentQuestion) ? 'bg-amber-500 text-white' : 'bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400'}`}
                                                >
                                                    {flags.includes(currentQuestion) ? 'üö©' : 'üè≥Ô∏è'} {t('flagged')}
                                                </button>
                                                
                                                <button 
                                                    onClick={() => clearRow(currentQuestion)}
                                                    disabled={!answers[currentQuestion]}
                                                    className={`px-3 py-2 rounded-lg ${answers[currentQuestion] ? 'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400' : 'opacity-50 cursor-not-allowed'}`}
                                                >
                                                    {t('clear_selection')}
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    {/* OMR Grid */}
                                    <div className="p-4 lg:p-6 overflow-y-auto max-h-[calc(100vh-300px)]">
                                        <div className="exam-grid grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                            {Array.from({ length: config.questionCount }, (_, i) => i + 1).map(qNum => (
                                                <div 
                                                    key={qNum}
                                                    id={`question-${qNum}`}
                                                    className={`
                                                        glass-panel p-4 rounded-2xl border transition-all duration-200
                                                        ${flags.includes(qNum) ? 'border-amber-400 bg-amber-50/50 dark:bg-amber-900/20' : 'border-slate-200 dark:border-slate-700'}
                                                        ${answers[qNum] ? 'shadow-md border-blue-300 dark:border-blue-500' : 'hover:border-slate-300 dark:hover:border-slate-600'}
                                                        ${currentQuestion === qNum ? 'ring-2 ring-blue-500 ring-offset-2' : ''}
                                                    `}
                                                    onClick={() => setCurrentQuestion(qNum)}
                                                >
                                                    <div className="flex items-center gap-3">
                                                        {/* Question Number with Flag */}
                                                        <div 
                                                            className={`w-10 h-10 flex items-center justify-center font-bold rounded-xl text-base cursor-pointer transition-all ${flags.includes(qNum) ? 'bg-amber-500 text-white' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400'}`}
                                                            onClick={(e) => {
                                                                e.stopPropagation();
                                                                toggleFlag(qNum);
                                                            }}
                                                            title={t('flag_review')}
                                                        >
                                                            {flags.includes(qNum) ? 'üö©' : qNum}
                                                        </div>

                                                        {/* Bubbles */}
                                                        <div className="flex-1 flex justify-between gap-2">
                                                            {options.map(opt => (
                                                                <button
                                                                    key={opt}
                                                                    onClick={(e) => {
                                                                        e.stopPropagation();
                                                                        handleBubbleClick(qNum, opt);
                                                                    }}
                                                                    className={`
                                                                        w-10 h-10 rounded-full text-base font-bold flex items-center justify-center border-2 bubble
                                                                        ${answers[qNum] === opt 
                                                                            ? 'bg-gradient-to-br from-blue-500 to-indigo-500 border-blue-500 text-white shadow-lg transform scale-105' 
                                                                            : 'bg-white dark:bg-slate-800 border-slate-300 dark:border-slate-600 text-slate-500 dark:text-slate-400 hover:border-blue-400 dark:hover:border-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/30'}
                                                                    `}
                                                                >
                                                                    {opt}
                                                                </button>
                                                            ))}
                                                        </div>

                                                        {/* Clear Action */}
                                                        {answers[qNum] && (
                                                            <button 
                                                                onClick={(e) => {
                                                                    e.stopPropagation();
                                                                    clearRow(qNum);
                                                                }}
                                                                className="w-8 h-8 flex items-center justify-center text-slate-400 hover:text-red-500 dark:hover:text-red-400 transition-colors rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20"
                                                                title={t('clear_selection')}
                                                            >
                                                                <Icons.X />
                                                            </button>
                                                        )}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Mobile Footer Stats */}
                            <div className="lg:hidden glass-panel rounded-2xl p-4 mt-6">
                                <div className="grid grid-cols-3 gap-4">
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-blue-600 dark:text-blue-400">{attemptedCount}</div>
                                        <div className="text-xs text-slate-500 dark:text-slate-400">{t('attempted')}</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-amber-600 dark:text-amber-400">{flags.length}</div>
                                        <div className="text-xs text-slate-500 dark:text-slate-400">{t('flagged')}</div>
                                    </div>
                                    <div className="text-center">
                                        <div className="text-2xl font-bold text-slate-600 dark:text-slate-400">{unansweredCount}</div>
                                        <div className="text-xs text-slate-500 dark:text-slate-400">{t('unanswered')}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* Footer */}
                    <Footer />
                </div>
            );
        };

        // --- App Wrapper ---
        const AppWrapper = () => {
            const [lang, setLang] = useState('en');
            const [darkMode, setDarkMode] = useState(false);

            useEffect(() => {
                const savedLang = localStorage.getItem('lang');
                if (savedLang) setLang(savedLang);
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    setDarkMode(true);
                    document.documentElement.classList.add('dark');
                }
            }, []);

            return (
                <AppContext.Provider value={{ lang, setLang, darkMode, setDarkMode }}>
                    <ExamInterface />
                </AppContext.Provider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AppWrapper />);
    </script>
</body>
</html>